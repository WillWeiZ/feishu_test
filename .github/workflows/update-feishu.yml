name: Update Feishu Stock Prices

on:
  schedule:
    # åŒ—äº¬æ—¶é—´12:00å’Œ15:30è¿è¡Œ (UTCæ—¶é—´4:00å’Œ7:30)
    # 12:00 -> 4:00 UTC, 15:30 -> 7:30 UTC
    - cron: '0 4 * * 1-5'     # åŒ—äº¬æ—¶é—´12:00 (ä¸­åˆ)
    - cron: '30 7 * * 1-5'    # åŒ—äº¬æ—¶é—´15:30 (æ”¶ç›˜å)
  workflow_dispatch: {}

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run updater
        env:
          # åŸºæœ¬é…ç½®
          APP_TOKEN: ${{ secrets.FEISHU_APP_TOKEN }}
          TABLE_ID: ${{ secrets.FEISHU_TABLE_ID }}
          TARGET_FIELD_ID: ${{ secrets.FEISHU_TARGET_FIELD_ID }}
          TARGET_FIELD_NAME: ${{ secrets.FEISHU_TARGET_FIELD_NAME }}

          # App Tokené…ç½® (æ¨èä½¿ç”¨ï¼Œé•¿æœŸæœ‰æ•ˆ)
          APP_ID: ${{ secrets.FEISHU_APP_ID }}
          APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}

          # å¤‡ç”¨User Token (å¦‚æœApp Tokenä¸å¯ç”¨)
          USER_ACCESS_TOKEN: ${{ secrets.FEISHU_USER_ACCESS_TOKEN }}
        run: |
          echo "ğŸš€ å¼€å§‹æ›´æ–°é£ä¹¦å¤šç»´è¡¨æ ¼è‚¡ç¥¨ä»·æ ¼..."
          echo "ğŸ“… è¿è¡Œæ—¶é—´: $(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S %Z')"

          # è¿è¡Œä¸»ç¨‹åºå¹¶å¤„ç†é”™è¯¯
          if python scripts/main.py; then
            echo "âœ… è‚¡ç¥¨ä»·æ ¼æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ è‚¡ç¥¨ä»·æ ¼æ›´æ–°å¤±è´¥"
            exit 1
          fi

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-${{ github.run_number }}
          path: |
            *.log
            data/
          retention-days: 7

